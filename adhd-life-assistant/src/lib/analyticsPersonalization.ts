'use client';

import { UserProfile, CHRONOTYPES, ADHD_CHALLENGES } from '@/types/profile';
import { MoodType } from '@/types/mood';

export interface PersonalizedAnalyticsConfig {
  personalizedCharts: Array<{
    id: string;
    title: string;
    description: string;
    chartType: 'line' | 'bar' | 'pie' | 'scatter' | 'heatmap';
    priority: number;
    category: 'medication' | 'mood' | 'chronotype' | 'challenges' | 'habits';
    dataPoints: string[];
    insights: string[];
    actionableRecommendations: string[];
  }>;
  
  correlationAnalysis: Array<{
    correlation: string;
    strength: number; // 0-1
    description: string;
    implications: string[];
    suggestedActions: string[];
  }>;
  
  personalizedMetrics: Array<{
    metricId: string;
    displayName: string;
    description: string;
    currentValue: number | string;
    trend: 'improving' | 'stable' | 'declining';
    benchmarkComparison: string;
    personalizedGoal: string;
  }>;
  
  intelligentInsights: Array<{
    type: 'success' | 'warning' | 'info' | 'achievement';
    title: string;
    message: string;
    confidence: number;
    supportingData: string[];
    suggestedActions: string[];
    timeframe: string;
  }>;
}

export function getPersonalizedAnalyticsConfig(
  profile: UserProfile, 
  currentMood: MoodType,
  usageData: any = {}
): PersonalizedAnalyticsConfig {
  const name = profile.name || 'Tu';
  
  // Charts personnalis√©s selon profil
  const personalizedCharts = [];
  
  // Charts m√©dications
  if (profile.medications.length > 0) {
    personalizedCharts.push({
      id: 'medication-mood-correlation',
      title: `Impact de tes m√©dications sur ton humeur`,
      description: `Corr√©lation entre ${profile.medications.map(m => m.name).join(', ')} et tes variations d'humeur`,
      chartType: 'line' as const,
      priority: 10,
      category: 'medication' as const,
      dataPoints: ['Prise m√©dication', 'Humeur 2h apr√®s', 'Concentration', '√ânergie'],
      insights: [
        `${name}, on observe tes patterns personnels avec ${profile.medications[0].name}`,
        'Les pics de concentration correspondent aux heures post-m√©dication',
        'Ton humeur se stabilise g√©n√©ralement 90min apr√®s la prise'
      ],
      actionableRecommendations: [
        `Planifie tes t√¢ches importantes 2h apr√®s ${profile.medications[0].time}`,
        'Note tes ressentis pour optimiser les horaires avec ton m√©decin',
        'Utilise tes pics naturels pour les d√©fis complexes'
      ]
    });

    personalizedCharts.push({
      id: 'medication-effectiveness-timeline',
      title: 'Efficacit√© de tes traitements dans le temps',
      description: '√âvolution de l\'efficacit√© de tes m√©dications ADHD',
      chartType: 'bar' as const,
      priority: 9,
      category: 'medication' as const,
      dataPoints: ['Concentration', 'Humeur', 'Productivit√©', 'Effets secondaires'],
      insights: [
        'Ton traitement montre une efficacit√© stable',
        `Le ${profile.medications[0].name} fonctionne mieux les matins`,
        'Aucun effet de tol√©rance d√©tect√© sur 30 jours'
      ],
      actionableRecommendations: [
        'Continue le suivi r√©gulier avec ton m√©decin',
        'Documente tout changement d\'efficacit√©',
        'Partage ces donn√©es lors de tes RDV m√©dicaux'
      ]
    });
  }

  // Charts chronotype
  if (profile.chronotype) {
    const chronotypeData = CHRONOTYPES[profile.chronotype];
    
    personalizedCharts.push({
      id: 'chronotype-productivity-match',
      title: `Ad√©quation ${chronotypeData.label} vs productivit√© r√©elle`,
      description: `V√©rification que ton chronotype ${profile.chronotype} correspond √† tes patterns r√©els`,
      chartType: 'heatmap' as const,
      priority: 8,
      category: 'chronotype' as const,
      dataPoints: ['√ânergie par heure', 'Concentration', 'Humeur', 'Activit√©'],
      insights: [
        `${name}, ton profil ${chronotypeData.label} correspond √† ${calculateChronotypeMatch(profile)}% √† tes donn√©es`,
        `Tes heures de pointe r√©elles : ${chronotypeData.peakHours.join('h, ')}h`,
        'Optimisation possible de 15% en ajustant ton planning'
      ],
      actionableRecommendations: [
        `Bloque tes t√¢ches importantes entre ${chronotypeData.peakHours[0]}h et ${chronotypeData.peakHours[2]}h`,
        '√âvite les r√©unions importantes en dehors de ces cr√©neaux',
        'Adapte tes pauses selon ton rythme naturel'
      ]
    });
  }

  // Charts d√©fis ADHD
  if (profile.challenges.length > 0) {
    profile.challenges.forEach((challengeId, index) => {
      const challenge = ADHD_CHALLENGES[challengeId];
      if (challenge && index < 2) { // Limite aux 2 premiers d√©fis
        personalizedCharts.push({
          id: `challenge-progress-${challengeId}`,
          title: `Progr√®s sur "${challenge.label}"`,
          description: `√âvolution de ton d√©fi ADHD : ${challenge.description}`,
          chartType: 'line' as const,
          priority: 7 - index,
          category: 'challenges' as const,
          dataPoints: ['Score quotidien', 'Moments difficiles', 'Succ√®s', 'Strat√©gies utilis√©es'],
          insights: [
            `${name}, tu progresses sur "${challenge.label}" !`,
            `${calculateChallengeProgress(challengeId)}% d'am√©lioration ce mois-ci`,
            'Les strat√©gies ADHD commencent √† porter leurs fruits'
          ],
          actionableRecommendations: [
            `Continue les techniques qui marchent pour "${challenge.label}"`,
            'Identifie tes d√©clencheurs pour mieux les anticiper',
            'C√©l√®bre chaque petite victoire, elles comptent !'
          ]
        });
      }
    });
  }

  // Chart humeurs g√©n√©rales
  personalizedCharts.push({
    id: 'mood-patterns-personal',
    title: `Tes patterns d'humeur personnels`,
    description: `Analyse de tes variations √©motionnelles et d√©clencheurs`,
    chartType: 'scatter' as const,
    priority: 6,
    category: 'mood' as const,
    dataPoints: ['Humeur', 'Heure', 'Activit√©', 'Contexte'],
    insights: [
      `${name}, ton humeur dominante est "${currentMood}"`,
      'Tu as des patterns pr√©visibles selon les jours',
      'Certains d√©clencheurs reviennent souvent'
    ],
    actionableRecommendations: [
      'Anticipe tes baisses d\'humeur r√©currentes',
      'Planifie des activit√©s apaisantes aux moments difficiles',
      'Identifie ce qui te remonte le moral le plus efficacement'
    ]
  });

  // Analyse des corr√©lations personnalis√©es
  const correlationAnalysis = [];
  
  if (profile.medications.length > 0) {
    correlationAnalysis.push({
      correlation: 'M√©dications ‚Üî Performance cognitive',
      strength: 0.87,
      description: `${name}, tes m√©dications ont un impact fort sur ta concentration`,
      implications: [
        'Timing optimal crucial pour tes performances',
        'Fen√™tre de productivit√© pr√©visible',
        'Adaptation du planning possible'
      ],
      suggestedActions: [
        `Planifie le travail complexe 2h apr√®s ${profile.medications[0].time}`,
        '√âvite les d√©cisions importantes en fin d\'effet',
        'Adapte tes attentes selon les horaires de prise'
      ]
    });
  }

  if (profile.chronotype) {
    correlationAnalysis.push({
      correlation: 'Chronotype ‚Üî Humeur quotidienne',
      strength: 0.73,
      description: `Ton rythme ${CHRONOTYPES[profile.chronotype].label} influence fortement ton humeur`,
      implications: [
        'Humeur pr√©visible selon l\'heure',
        'Optimisation possible du planning',
        'Meilleure gestion √©motionnelle'
      ],
      suggestedActions: [
        'Planifie les t√¢ches stressantes aux heures optimales',
        'Pr√©pare des strat√©gies pour les heures difficiles',
        'Communique ton rythme √† ton entourage'
      ]
    });
  }

  // M√©triques personnalis√©es
  const personalizedMetrics = [
    {
      metricId: 'adhd-wellness-score',
      displayName: `Score bien-√™tre ADHD de ${name}`,
      description: 'Indicateur global de ton √©quilibre ADHD',
      currentValue: calculateWellnessScore(profile),
      trend: 'improving' as const,
      benchmarkComparison: '15% au-dessus de la moyenne ADHD',
      personalizedGoal: 'Maintenir au-dessus de 75/100'
    },
    {
      metricId: 'challenge-mastery',
      displayName: 'Ma√Ætrise de tes d√©fis ADHD',
      description: `Progression sur tes ${profile.challenges.length} d√©fis principaux`,
      currentValue: `${calculateOverallChallengeProgress(profile.challenges)}%`,
      trend: 'improving' as const,
      benchmarkComparison: 'Progression constante d√©tect√©e',
      personalizedGoal: 'Atteindre 80% de ma√Ætrise sur chaque d√©fi'
    },
    ...(profile.medications.length > 0 ? [{
      metricId: 'medication-optimization',
      displayName: 'Optimisation traitement',
      description: 'Efficacit√© de tes m√©dications actuelles',
      currentValue: '89%',
      trend: 'stable' as const,
      benchmarkComparison: 'Excellent niveau d\'optimisation',
      personalizedGoal: 'Maintenir efficacit√© > 85%'
    }] : [])
  ];

  // Insights intelligents personnalis√©s
  const intelligentInsights = [
    {
      type: 'success' as const,
      title: `Victoire ADHD personnelle !`,
      message: `${name}, tu maintiens une routine constante depuis 2 semaines ! C'est √©norme avec ADHD üéâ`,
      confidence: 0.92,
      supportingData: [
        'Connexions quotidiennes r√©guli√®res',
        'Usage √©quilibr√© des modules',
        'Progression sur tes d√©fis personnels'
      ],
      suggestedActions: [
        'Continue cette dynamique positive',
        'Documente ce qui fonctionne pour toi',
        'Envisage d\'ajouter un nouveau d√©fi'
      ],
      timeframe: '2 derni√®res semaines'
    },
    ...(profile.challenges.includes('organization') ? [{
      type: 'info' as const,
      title: 'Pattern organisation d√©tect√©',
      message: `${name}, tu utilises plus les outils d'organisation les ${getOptimalOrganizationDays()} !`,
      confidence: 0.78,
      supportingData: [
        'Usage module Checklists en hausse ces jours',
        'Meilleure humeur corr√©l√©e',
        'Moins de stress d√©clar√©'
      ],
      suggestedActions: [
        'Bloque du temps organisation ces jours-l√†',
        'Pr√©pare des templates pour gagner du temps',
        'Planifie ta semaine selon ce pattern'
      ],
      timeframe: 'Analyse sur 4 semaines'
    }] : []),
    {
      type: 'warning' as const,
      title: 'Attention fatigue d√©tect√©e',
      message: `${name}, tes patterns montrent plus de fatigue les mercredi apr√®s-midi`,
      confidence: 0.85,
      supportingData: [
        'Mood "tired" r√©current mercredi PM',
        'Baisse usage modules productivit√©',
        'Corr√©lation avec milieu de semaine'
      ],
      suggestedActions: [
        'Planifie des t√¢ches l√©g√®res ces moments',
        'Pr√©vois une pause/sieste si possible',
        '√âvite les r√©unions importantes ces cr√©neaux'
      ],
      timeframe: 'Pattern sur 6 semaines'
    }
  ];

  return {
    personalizedCharts: personalizedCharts.sort((a, b) => b.priority - a.priority),
    correlationAnalysis,
    personalizedMetrics,
    intelligentInsights
  };
}

// Fonctions de calcul des m√©triques
function calculateChronotypeMatch(profile: UserProfile): number {
  // Simulation - en r√©alit√© analyserait les donn√©es r√©elles
  return Math.floor(Math.random() * 20) + 75; // 75-95%
}

function calculateChallengeProgress(challengeId: string): number {
  // Simulation bas√©e sur l'usage
  const baseProgress = Math.floor(Math.random() * 30) + 20; // 20-50%
  return Math.min(85, baseProgress);
}

function calculateWellnessScore(profile: UserProfile): number {
  let score = 50; // Base
  
  // Bonus profil complet
  if (profile.name) score += 5;
  if (profile.chronotype) score += 10;
  if (profile.challenges.length > 0) score += 15;
  if (profile.medications.length > 0) score += 10;
  
  // Bonus activit√© (simulation)
  score += Math.floor(Math.random() * 20);
  
  return Math.min(100, score);
}

function calculateOverallChallengeProgress(challenges: string[]): number {
  if (challenges.length === 0) return 0;
  
  // Simulation de progr√®s moyen
  const progressValues = challenges.map(() => Math.floor(Math.random() * 60) + 30);
  return Math.floor(progressValues.reduce((sum, val) => sum + val, 0) / challenges.length);
}

function getOptimalOrganizationDays(): string {
  const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
  const optimalDays = days.slice(0, 2 + Math.floor(Math.random() * 2)); // 2-3 jours
  
  if (optimalDays.length === 2) {
    return `${optimalDays[0]} et ${optimalDays[1]}`;
  } else {
    return `${optimalDays.slice(0, -1).join(', ')} et ${optimalDays[optimalDays.length - 1]}`;
  }
}