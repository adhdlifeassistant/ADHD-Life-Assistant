'use client';

import React from 'react';
import { useMood } from '@/modules/mood/MoodContext';
import { useProfile } from '@/hooks/useProfile';
import { useAppSettings } from '@/hooks/useAppSettings';
import { getPersonalizedGreeting, getMotivationalMessage, getSupportiveMessage } from '@/lib/moodGreetings';
import { getRecommendedModules } from '@/lib/moodPriorities';
import { 
  getPersonalizedDashboardGreeting, 
  getChronotypeTimingSuggestions,
  getPriorityModulesForChallenges,
  getTodayMedications,
  getPersonalizedChatTeaser,
  getPersonalizedAnalyticsInsights
} from '@/lib/personalizedDashboard';
import { useDashboard } from './DashboardContext';
import QuickReminders from './widgets/QuickReminders';
import QuickActions from './widgets/QuickActions';
import PersonalizedChatTeaser from './widgets/PersonalizedChatTeaser';
import PersonalizedAnalytics from './widgets/PersonalizedAnalytics';

export default function DashboardHome() {
  const { currentMood, getMoodConfig } = useMood();
  const { profile } = useProfile();
  const { settings } = useAppSettings();
  const { setView } = useDashboard();
  const moodConfig = getMoodConfig();

  const currentTime = new Date();
  const dateFormatted = currentTime.toLocaleDateString('fr-FR', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  // Contexte personnalis√©
  const dashboardContext = {
    profile,
    currentMood,
    currentTime
  };

  // Modules recommand√©s : personnalis√©s si profil complet, sinon mood standard
  const recommendedModules = profile.onboardingCompleted && profile.challenges.length > 0
    ? getPriorityModulesForChallenges(profile.challenges)
    : getRecommendedModules(currentMood);

  // M√©dications du jour
  const todayMedications = getTodayMedications(profile);
  
  // Suggestions chronotype
  const chronotypeSuggestion = getChronotypeTimingSuggestions(dashboardContext);
  
  // Analytics personnalis√©es
  const personalizedAnalytics = getPersonalizedAnalyticsInsights(profile);

  return (
    <div className="space-y-8">
      {/* Header avec salutation personnalis√©e */}
      <div className={`text-center p-8 rounded-3xl glow-${currentMood}`} style={{ backgroundColor: 'var(--mood-secondary)' }}>
        <div className={`text-4xl mb-4 animated-emoji`}>
          {settings.avatar || moodConfig.emoji}
        </div>
        <h1 className="text-3xl md:text-4xl font-bold mb-4" style={{ color: 'var(--mood-text)' }}>
          {profile.name && profile.onboardingCompleted 
            ? getPersonalizedDashboardGreeting(dashboardContext)
            : getPersonalizedGreeting(currentMood)
          }
        </h1>
        <p className="text-sm opacity-60" style={{ color: 'var(--mood-text)' }}>
          {dateFormatted}
          {profile.name && (
            <> ‚Ä¢ Salut {profile.name} ! Comment tu te sens aujourd'hui ?</>
          )}
        </p>
      </div>

      {/* Rappels m√©dications personnels */}
      {todayMedications.length > 0 && (
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 border border-blue-200">
          <h3 className="font-semibold mb-4 flex items-center gap-2 text-blue-800">
            <span className="text-xl">üíä</span>
            Mes rappels aujourd'hui ({todayMedications.length})
          </h3>
          
          <div className="grid gap-3">
            {todayMedications.map(med => (
              <div 
                key={med.id}
                className={`flex items-center justify-between p-4 rounded-xl border-2 ${
                  med.status === 'now' ? 'bg-orange-100 border-orange-300' :
                  med.status === 'missed' ? 'bg-red-100 border-red-300' :
                  med.status === 'taken' ? 'bg-green-100 border-green-300' :
                  'bg-white border-blue-200'
                }`}
              >
                <div className="flex items-center gap-3">
                  <span className={`text-2xl ${
                    med.status === 'now' ? '‚è∞' :
                    med.status === 'missed' ? '‚ö†Ô∏è' :
                    med.status === 'taken' ? '‚úÖ' :
                    'üíä'
                  }`} />
                  <div>
                    <p className="font-medium text-gray-800">{med.name}</p>
                    <p className="text-sm text-gray-600">{med.time}</p>
                  </div>
                </div>
                <div className="text-right">
                  <span className={`text-sm font-medium ${
                    med.status === 'now' ? 'text-orange-700' :
                    med.status === 'missed' ? 'text-red-700' :
                    med.status === 'taken' ? 'text-green-700' :
                    'text-blue-700'
                  }`}>
                    {med.timeUntil}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Suggestion chronotype */}
      {chronotypeSuggestion && (
        <div className="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-6 border border-orange-200">
          <div className="flex items-start gap-3">
            <span className="text-2xl">‚è∞</span>
            <div>
              <h3 className="font-semibold text-orange-800 mb-2">Timing optimal</h3>
              <p className="text-sm text-orange-700">{chronotypeSuggestion}</p>
            </div>
          </div>
        </div>
      )}

      {/* Modules prioritaires selon d√©fis ADHD ou mood */}
      {recommendedModules.length > 0 && (
        <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-white/20">
          <h3 className="font-semibold mb-4 flex items-center gap-2" style={{ color: 'var(--mood-text)' }}>
            <span className="text-xl">üéØ</span>
            {profile.onboardingCompleted && profile.challenges.length > 0 
              ? 'Mes modules prioritaires (selon tes d√©fis ADHD)'
              : `Recommand√© pour ton mood ${moodConfig.label}`
            }
          </h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {recommendedModules.map(module => {
              const moduleId = (module as any).moduleId || (module as any).id;
              const reason = (module as any).reason;
              
              return (
                <button
                  key={moduleId}
                  onClick={() => setView(moduleId)}
                  className={`
                    p-4 rounded-xl border-2 transition-all hover:scale-105
                    ${moodConfig.bgColor} ${moodConfig.textColor} border-current
                    hover:shadow-lg
                  `}
                >
                  <div className="text-left">
                    <p className="font-medium mb-1">
                      {getModuleLabel(moduleId)}
                    </p>
                    <p className="text-sm opacity-80">
                      {reason}
                    </p>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      )}

      {/* M√©triques du jour */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className={`p-4 rounded-xl ${moodConfig.bgColor} ${moodConfig.textColor}`}>
          <div className="flex items-center gap-3">
            <span className="text-2xl">üí™</span>
            <div>
              <p className="font-semibold">Mode {moodConfig.label}</p>
              <p className="text-sm opacity-80">{moodConfig.description}</p>
            </div>
          </div>
        </div>

        <div className="p-4 rounded-xl bg-white/70 backdrop-blur-sm border border-white/20">
          <div className="flex items-center gap-3">
            <span className="text-2xl">üìÖ</span>
            <div>
              <p className="font-semibold" style={{ color: 'var(--mood-text)' }}>Aujourd'hui</p>
              <p className="text-sm opacity-70" style={{ color: 'var(--mood-text)' }}>
                {currentTime.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}
              </p>
            </div>
          </div>
        </div>

        <div className="p-4 rounded-xl bg-white/70 backdrop-blur-sm border border-white/20">
          <div className="flex items-center gap-3">
            <span className="text-2xl">üéØ</span>
            <div>
              <p className="font-semibold" style={{ color: 'var(--mood-text)' }}>
                {profile.onboardingCompleted && profile.challenges.length > 0
                  ? `Focus: ${profile.challenges[0].replace('-', ' ')}`
                  : 'Focus du jour'
                }
              </p>
              <p className="text-sm opacity-70" style={{ color: 'var(--mood-text)' }}>
                {profile.onboardingCompleted && profile.challenges.length > 0
                  ? 'Ton d√©fi prioritaire'
                  : 'Prendre soin de soi'
                }
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Widgets personnalis√©s */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <PersonalizedChatTeaser />
        <PersonalizedAnalytics />
      </div>
      
      {/* Widgets secondaires */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <QuickReminders />
        <QuickActions />
      </div>

      {/* Messages motivationnel et de soutien */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className={`p-6 rounded-xl ${moodConfig.bgColor} ${moodConfig.textColor}`}>
          <div className="flex items-start gap-3">
            <span className="text-2xl">üí™</span>
            <div>
              <h3 className="font-semibold mb-2">Message motivationnel</h3>
              <p className="text-sm opacity-90">
                {getMotivationalMessage(currentMood)}
              </p>
            </div>
          </div>
        </div>

        <div className={`p-6 rounded-xl bg-white/70 backdrop-blur-sm border`} style={{ borderColor: 'var(--mood-border)' }}>
          <div className="flex items-start gap-3">
            <span className="text-2xl">ü§ó</span>
            <div>
              <h3 className="font-semibold mb-2" style={{ color: 'var(--mood-text)' }}>
                Message de soutien
              </h3>
              <p className="text-sm opacity-80" style={{ color: 'var(--mood-text)' }}>
                {getSupportiveMessage(currentMood)}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Prochaines actions sugg√©r√©es */}
      <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-white/20">
        <h3 className="font-semibold mb-4 flex items-center gap-2" style={{ color: 'var(--mood-text)' }}>
          <span className="text-xl">üöÄ</span>
          Suggestions pour aujourd'hui
        </h3>
        
        <div className="space-y-3">
          {getSuggestions(currentMood).map((suggestion, index) => (
            <div key={index} className="flex items-center gap-3 p-3 rounded-xl bg-slate-50">
              <span className="text-lg">{suggestion.icon}</span>
              <p className="text-sm text-slate-700">{suggestion.text}</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

function getMoodTip(mood: string): string {
  const tips = {
    energetic: "Profite de cette √©nergie ! C'est le moment parfait pour tacler les t√¢ches importantes et cr√©atives. N'oublie pas de prendre des pauses pour ne pas t'√©puiser.",
    normal: "Tu es dans un bon √©quilibre aujourd'hui. C'est parfait pour avancer sur tes projets de fa√ßon r√©guli√®re et prendre soin de toi.",
    tired: "C'est ok d'√™tre fatigu√©. Concentre-toi sur les essentiels et n'h√©site pas √† te reposer. Ton corps et ton esprit ont besoin de r√©cup√©rer.",
    stressed: "Respire profond√©ment. Priorise ce qui est vraiment urgent et laisse le reste pour plus tard. Une chose √† la fois, tu y arriveras.",
    sad: "Sois doux/douce avec toi-m√™me aujourd'hui. Il n'y a pas de pression √† √™tre productif/ve. Fais ce qui te fait du bien et demande de l'aide si besoin."
  };
  return tips[mood as keyof typeof tips] || tips.normal;
}

function getModuleLabel(moduleId: string): string {
  const labels: Record<string, string> = {
    'chat': 'üí¨ Chat Claude',
    'reminders': '‚è∞ Rappels',
    'cooking': 'üç≥ Cuisine',
    'checklists': 'üìã Checklists',
    'finance': 'üí∞ Finances',
    'cleaning': 'üßπ M√©nage',
    'health': 'üè• Sant√©',
    'analytics': 'üìà Analytics',
    'tasks': '‚úÖ T√¢ches',
    'focus': 'üéØ Focus'
  };
  return labels[moduleId] || moduleId;
}

function getSuggestions(mood: string): Array<{icon: string, text: string}> {
  const suggestions = {
    energetic: [
      { icon: 'üéØ', text: 'Commence une session de focus sur ton projet principal' },
      { icon: 'üìù', text: '√âcris tes id√©es cr√©atives du moment' },
      { icon: 'üèÉ‚Äç‚ôÄÔ∏è', text: 'Profite de cette √©nergie pour bouger un peu' }
    ],
    normal: [
      { icon: 'üìã', text: 'R√©vise ta liste de t√¢ches et priorise' },
      { icon: 'üí¨', text: 'Parle √† Claude de tes objectifs du jour' },
      { icon: 'üßò‚Äç‚ôÄÔ∏è', text: 'Prends 5 minutes pour m√©diter' }
    ],
    tired: [
      { icon: '‚òï', text: 'Bois un verre d\'eau ou une tisane' },
      { icon: 'üõèÔ∏è', text: 'Accorde-toi une sieste de 20 minutes' },
      { icon: 'üéµ', text: '√âcoute de la musique relaxante' }
    ],
    stressed: [
      { icon: 'ü´Å', text: 'Fais 3 respirations profondes maintenant' },
      { icon: 'üìù', text: '√âcris ce qui te stresse pour vider ta t√™te' },
      { icon: 'üö∂‚Äç‚ôÄÔ∏è', text: 'Sors prendre l\'air 5 minutes' }
    ],
    sad: [
      { icon: 'ü§ó', text: 'Contacte un proche qui te fait du bien' },
      { icon: 'üé¨', text: 'Regarde quelque chose qui te r√©conforte' },
      { icon: 'üõÅ', text: 'Prends un bain ou une douche chaude' }
    ]
  };
  return suggestions[mood as keyof typeof suggestions] || suggestions.normal;
}